<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Assistant</title>
<style>
* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
}

html, body {
  height: 100%; 
  width: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0d1117;
  color: #e6edf3;
  display: flex; 
  flex-direction: column;
}

.app-container {
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #0d1117;
}

#mode-bar {
  display: flex; 
  gap: 0; 
  padding: 8px;
  background: #161b22;
  border-bottom: 1px solid #21262d;
  box-shadow: 0 1px 0 rgba(255,255,255,0.03);
}

#mode-bar button {
  flex: 1; 
  padding: 12px 16px; 
  font-size: 16px; 
  font-weight: 600;
  border: none; 
  cursor: pointer; 
  transition: all 0.2s ease;
  background: transparent;
  color: #e6edf3;
  border-radius: 0;
}

#mode-bar button.active { 
  background: #21262d;
  color: #fff;
}

#mode-bar button:first-child.active {
  border-radius: 8px 0 0 8px;
}

#mode-bar button:last-child.active {
  border-radius: 0 8px 8px 0;
}

#mode-bar button:only-child.active {
  border-radius: 8px;
}

#chat-container {
  flex: 1 1 auto; 
  overflow-y: auto; 
  padding: 16px;
  background: #0d1117;
  margin-bottom: 80px;
  scroll-behavior: smooth;
  scrollbar-width: thin;
  scrollbar-color: #30363d transparent;
}

#chat-container::-webkit-scrollbar {
  width: 6px;
}

#chat-container::-webkit-scrollbar-track {
  background: transparent;
}

#chat-container::-webkit-scrollbar-thumb {
  background: #30363d;
  border-radius: 3px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

#chat-container:hover::-webkit-scrollbar-thumb {
  opacity: 1;
}

#chat-container::-webkit-scrollbar-thumb:hover {
  background: #484f58;
}

.message-group { 
  margin-bottom: 16px; 
}

.message {
  display: flex; 
  align-items: flex-start; 
  margin-bottom: 2px;
  max-width: 100%;
  padding: 12px 0;
}

.message.user { 
  justify-content: flex-end; 
}

.message.bot { 
  justify-content: flex-start;
  background: #161b22;
  margin: 0 -16px;
  padding: 16px;
}

.bubble {
  max-width: 100%; 
  padding: 0; 
  border-radius: 0; 
  word-wrap: break-word;
  font-size: 16px; 
  line-height: 1.6;
  position: relative;
  margin: 0;
  background: transparent;
}

.bubble.user {
  background: transparent;
  color: #e6edf3; 
  text-align: right;
}

.bubble.bot {
  background: transparent;
  color: #e6edf3;
  text-align: left;
}

.message-info {
  font-size: 12px; 
  opacity: 0.6; 
  margin-top: 4px;
  text-align: center;
  width: 100%;
  color: #7d8590;
}

.typing-indicator {
  display: none; 
  align-items: center; 
  padding: 16px;
  background: #161b22; 
  margin: 0 -16px;
  color: #7d8590;
  font-size: 14px;
}

.typing-indicator .dots {
  display: inline-flex;
  align-items: center;
  margin-left: 8px;
}

.typing-indicator .dots span {
  height: 4px; 
  width: 4px; 
  border-radius: 50%; 
  background: #7d8590;
  display: inline-block; 
  margin: 0 2px; 
  animation: typing 1.4s infinite;
}

.typing-indicator .dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator .dots span:nth-child(3) { animation-delay: 0.4s; }

#text-mode, #voice-mode, #voice-cont-mode {
  position: fixed; 
  bottom: 0; 
  left: 50%;
  transform: translateX(-50%);
  width: 800px;
  max-width: calc(100% - 32px);
  z-index: 1000;
  background: #161b22;
  border-top: 1px solid #21262d;
  padding: 12px 16px;
  display: flex; 
  gap: 8px; 
  align-items: center;
  box-shadow: 0 -1px 0 rgba(255,255,255,0.03);
  border-radius: 12px 12px 0 0;
  margin-bottom: 0;
}

#text-mode .input-container {
  flex: 1; 
  display: flex; 
  gap: 8px; 
  align-items: center;
  background: #21262d;
  border-radius: 12px; 
  padding: 4px 4px 4px 16px;
  border: 1px solid #30363d;
}

#text-mode input {
  flex: 1; 
  padding: 12px 0; 
  font-size: 16px; 
  border: none; 
  outline: none;
  background: transparent; 
  color: #e6edf3;
}

#text-mode input::placeholder { 
  color: #7d8590; 
}

.btn {
  padding: 8px; 
  border-radius: 6px; 
  border: none; 
  cursor: pointer;
  font-size: 18px; 
  transition: all 0.2s ease; 
  display: flex;
  align-items: center; 
  justify-content: center; 
  min-width: 36px; 
  min-height: 36px;
  background: transparent;
}

.btn-primary { 
  background: #1a1f24; 
  color: #539bf5;
  border: 1px solid #30363d;
  font-size: 20px;
  transition: all 0.2s ease;
}

.btn-primary:hover { 
  background: #21262d;
  color: #77b3f7;
  transform: scale(1.05);
}

.btn-danger { 
  background: #ef4444; 
  color: #fff; 
}

.btn-danger:hover { 
  background: #dc2626;
}

.btn-mic { 
  background: #21262d;
  color: #e6edf3;
  border: 1px solid #30363d;
}

.btn-mic:hover { 
  background: #30363d; 
}

.btn-mic.recording { 
  background: #ef4444; 
  color: #fff;
  animation: pulse 1s infinite; 
}

.btn-speaker {
  background: #21262d;
  color: #e6edf3;
  border: 1px solid #30363d;
}

.btn-speaker:hover {
  background: #30363d;
}

.btn-speaker.speaking {
  background: #21262d;
  color: #fff;
  border: 1px solid #30363d;
}

#voice-mode, #voice-cont-mode {
  justify-content: center; 
  text-align: center; 
  flex-direction: row;
  gap: 8px;
  padding: 12px 16px;
  align-items: center;
}

#voice-mode .status, #voice-cont-mode .status {
  font-size: 14px; 
  color: #7d8590;
  margin-bottom: 0;
  margin-right: 12px;
  white-space: nowrap;
}

#voice-mode .controls, #voice-cont-mode .controls {
  display: flex; 
  gap: 8px; 
  justify-content: center;
  align-items: center;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-10px); opacity: 1; }
}

@media(max-width: 768px) {
  .app-container {
    max-width: 100%;
    margin: 0;
  }
  
  .bubble { 
    font-size: 16px; 
  }
  
  #mode-bar button { 
    padding: 10px 12px; 
    font-size: 15px; 
  }
  
  #text-mode, #voice-mode, #voice-cont-mode {
    width: 100%;
    left: 0;
    transform: none;
    max-width: none;
    margin: 0;
    border-radius: 0;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <div id="mode-bar">
    <button id="chatModeBtn" class="active" onclick="switchMode('chat')">Text</button>
    <button id="voiceBtn" onclick="switchMode('voice')">Voice</button>
    <button id="voiceContBtn" onclick="switchMode('voice-cont')">Continuous</button>
  </div>

  <div id="chat-container">
    <div class="welcome-message">
      <h2>AI Assistant</h2>
      <p>Send a message or use voice to get started</p>
    </div>
  </div>

  <div class="typing-indicator" id="typing-indicator">
    Generating response<div class="dots"><span></span><span></span><span></span></div>
  </div>

  <div id="text-mode">
    <div class="input-container">
      <input id="textInput" placeholder="Message" 
             onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault(); sendTextMessage();}">
      <button class="btn btn-mic" id="micBtn" onclick="toggleChatMic()">&#127908;</button>
    </div>
    <button class="btn btn-speaker" id="speakerBtn" onclick="toggleSpeaker()" title="Toggle speech (Ctrl+S)">&#128266;</button>
    <button class="btn btn-primary" onclick="sendTextMessage()">&#128233;</button>
    <button class="btn btn-danger" onclick="stopAll()">&#9209;</button>
  </div>

  <div id="voice-mode" style="display:none;">
    <div class="status">Voice Chat Mode</div>
    <div class="controls">
      <button class="btn btn-primary" onclick="startVoice()">&#127908;</button>
      <button class="btn btn-speaker" id="voiceSpeakerBtn" onclick="toggleSpeaker()" title="Toggle speech (Ctrl+S)">&#128266;</button>
      <button class="btn btn-danger" onclick="stopAll()">&#9209;</button>
    </div>
  </div>

  <div id="voice-cont-mode" style="display:none;">
    <div class="status">Continuous listening active</div>
    <div class="controls">
      <button class="btn btn-speaker" id="contSpeakerBtn" onclick="toggleSpeaker()" title="Toggle speech (Ctrl+S)">&#128266;</button>
      <button class="btn btn-danger" onclick="stopAll()">&#9209;</button>
    </div>
  </div>
</div>

<script>
let apiBase = "https://voice-assistant-program.onrender.com";
let speechEnabled = true, utter = null, audioUnlocked = false;
let currentMode = 'chat', chatMicActive = false, isProcessing = false;

// CREATE ONCE - NEVER CREATE AGAIN
let recognition = null;
let recognitionActive = false;

// Initialize everything when page loads
window.onload = () => {
  addWelcomeMessage();
  updateSpeakerButtons();
  
  // Create speech recognition ONCE here - SIMPLE!
  if (window.webkitSpeechRecognition) {
    recognition = new window.webkitSpeechRecognition();
    recognition.lang = "en-US";
    console.log("✅ Speech recognition created successfully!");
  } else if (window.SpeechRecognition) {
    recognition = new window.SpeechRecognition();
    recognition.lang = "en-US";
    console.log("✅ Speech recognition created successfully!");
  } else {
    console.log("❌ Speech recognition not supported in this browser");
  }
};

// Chat microphone functions
function startChatMic() {
  if (!recognition) {
    addMessage("Voice recognition not supported in this browser", "bot", "error");
    return;
  }
  
  if (recognitionActive) {
    console.log("Recognition already active, stopping");
    stopChatMic();
    return;
  }
  
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  
  const micBtn = document.getElementById('micBtn');
  micBtn.classList.add('recording');
  chatMicActive = true;
  
  recognition.continuous = false;
  recognition.interimResults = false;
  
  recognition.onstart = () => {
    console.log("Recognition started");
    recognitionActive = true;
  };
  
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    document.getElementById('textInput').value = transcript;
    stopChatMic();
    sendTextMessage();
  };
  
  recognition.onerror = (e) => {
    console.error('Speech error:', e.error);
    recognitionActive = false;
    
    if (e.error === 'no-speech') {
      addMessage("No speech detected. Please try again.", "bot", "status");
    } else if (e.error === 'not-allowed') {
      addMessage("Microphone access denied. Please allow microphone access.", "bot", "error");
    }
    
    stopChatMic();
  };
  
  recognition.onend = () => {
    console.log("Recognition ended");
    recognitionActive = false;
    
    // Only auto-stop the UI, don't restart
    if (chatMicActive) {
      const micBtn = document.getElementById('micBtn');
      micBtn.classList.remove('recording');
      chatMicActive = false;
    }
  };
  
  try {
    recognition.start();
  } catch (error) {
    console.error("Failed to start recognition:", error);
    recognitionActive = false;
    stopChatMic();
  }
}

function stopChatMic() {
  const micBtn = document.getElementById('micBtn');
  micBtn.classList.remove('recording');
  chatMicActive = false;
  
  if (recognition && recognitionActive) {
    try {
      recognition.stop();
    } catch (error) {
      console.error("Error stopping recognition:", error);
    }
  }
  
  recognitionActive = false;
}

function toggleChatMic() {
  if (chatMicActive) {
    stopChatMic();
  } else {
    startChatMic();
  }
}

// Voice mode functions
function startVoice() {
  if (!recognition) {
    addMessage("Voice recognition not supported in this browser", "bot", "error");
    return;
  }
  
  if (recognitionActive) {
    recognition.stop();
  }
  
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  
  recognition.continuous = false;
  recognition.interimResults = false;
  
  recognition.onstart = () => {
    recognitionActive = true;
  };
  
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    addMessage(transcript, "user");
    sendVoiceMessage(transcript);
  };
  
  recognition.onerror = (e) => {
    console.error('Speech error:', e);
    addMessage("I had trouble hearing you. Please try again.", "bot", "error");
    recognitionActive = false;
  };
  
  recognition.onend = () => {
    recognitionActive = false;
  };
  
  recognition.start();
  addMessage("I'm listening... speak now!", "bot", "status");
}

// Continuous voice mode
function startContinuousVoice() {
  if (!recognition) {
    addMessage("Voice recognition not supported in this browser", "bot", "error");
    return;
  }
  
  if (recognitionActive) {
    recognition.stop();
  }
  
  recognition.continuous = true;
  recognition.interimResults = false;
  
  recognition.onstart = () => {
    recognitionActive = true;
  };
  
  recognition.onresult = (e) => {
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        const transcript = e.results[i][0].transcript;
        addMessage(transcript, "user");
        sendVoiceMessage(transcript);
      }
    }
  };
  
  recognition.onerror = (e) => {
    console.error('Continuous speech error:', e);
    recognitionActive = false;
  };
  
  recognition.onend = () => {
    recognitionActive = false;
    if (currentMode === 'voice-cont') {
      setTimeout(() => {
        if (currentMode === 'voice-cont') {
          startContinuousVoice();
        }
      }, 1000);
    }
  };
  
  recognition.start();
  addMessage("Continuous listening activated. I'm ready to hear you anytime!", "bot", "status");
}

// Audio unlock
document.body.addEventListener("click", () => {
  if (!audioUnlocked) {
    speechSynthesis.speak(new SpeechSynthesisUtterance(""));
    audioUnlocked = true;
  }
}, { once: true });

// Speaker functions
function toggleSpeaker() {
  speechEnabled = !speechEnabled;
  updateSpeakerButtons();
  
  if (!speechEnabled && speechSynthesis.speaking) {
    speechSynthesis.cancel();
  }
}

function updateSpeakerButtons() {
  const buttons = ['speakerBtn', 'voiceSpeakerBtn', 'contSpeakerBtn'];
  buttons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      if (speechEnabled) {
        btn.classList.remove('speaking');
        btn.innerHTML = '&#128266;'; // Normal speaker icon
        btn.style.color = '#e6edf3';
        btn.style.background = '#21262d';
      } else {
        btn.innerHTML = '&#128263;'; // Speaker with slash (muted)
        btn.style.color = '#7d8590';
        btn.style.background = '#21262d';
      }
    }
  });
}

// Mode switching
function switchMode(mode) {
  currentMode = mode;
  stopAll();
  
  document.getElementById('text-mode').style.display = mode === 'chat' ? 'flex' : 'none';
  document.getElementById('voice-mode').style.display = mode === 'voice' ? 'flex' : 'none';
  document.getElementById('voice-cont-mode').style.display = mode === 'voice-cont' ? 'flex' : 'none';
  
  document.getElementById('chatModeBtn').classList.toggle('active', mode === 'chat');
  document.getElementById('voiceBtn').classList.toggle('active', mode === 'voice');
  document.getElementById('voiceContBtn').classList.toggle('active', mode === 'voice-cont');
  
  if (mode === 'voice-cont') {
    setTimeout(startContinuousVoice, 500);
  }
}

// Message functions
function addWelcomeMessage() {
}

function addMessage(text, sender, type = 'text', source = '') {
  const container = document.getElementById("chat-container");
  const welcome = container.querySelector('.welcome-message');
  if (welcome) welcome.style.display = 'none';
  
  const messageGroup = document.createElement("div");
  messageGroup.className = "message-group";
  
  const message = document.createElement("div");
  message.className = `message ${sender}`;
  
  const bubble = document.createElement("div");
  bubble.className = `bubble ${sender}`;
  bubble.textContent = text;
  
  message.appendChild(bubble);
  messageGroup.appendChild(message);
  
  container.appendChild(messageGroup);
  container.scrollTop = container.scrollHeight;
}

function showTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  const container = document.getElementById('chat-container');
  container.appendChild(indicator);
  indicator.style.display = 'flex';
  container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  indicator.style.display = 'none';
}

// Send message functions
async function sendTextMessage() {
  const input = document.getElementById("textInput");
  const text = input.value.trim();
  if (!text || isProcessing) return;
  
  isProcessing = true;
  stopAll();
  
  addMessage(text, "user");
  input.value = "";
  
  showTypingIndicator();
  
  try {
    const response = await fetch(`${apiBase}/ask?question=${encodeURIComponent(text)}`);
    const data = await response.json();
    
    hideTypingIndicator();
    
    const answerText = data.answer || "I didn't receive a proper response.";
    const source = data.source === 'gemini' ? 'AI' : (data.source === 'predefined' ? 'Quick Response' : '');
    
    addMessage(answerText, "bot", data.type || 'text', source);
    
    if (audioUnlocked && speechEnabled) {
      const speakerBtns = document.querySelectorAll('.btn-speaker');
      speakerBtns.forEach(btn => btn.classList.add('speaking'));
      
      speak(answerText, () => {
        speakerBtns.forEach(btn => btn.classList.remove('speaking'));
      });
    }
    
  } catch (error) {
    hideTypingIndicator();
    console.error('Error:', error);
    addMessage("I'm having trouble connecting right now. Please try again.", "bot", "error");
  }
  
  isProcessing = false;
}

async function sendVoiceMessage(text) {
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  if (isProcessing) return;
  
  isProcessing = true;
  showTypingIndicator();
  
  try {
    const response = await fetch(`${apiBase}/ask?question=${encodeURIComponent(text)}`);
    const data = await response.json();
    
    hideTypingIndicator();
    
    const answerText = data.answer || "I didn't receive a proper response.";
    const source = data.source === 'gemini' ? 'AI' : (data.source === 'predefined' ? 'Quick Response' : '');
    
    addMessage(answerText, "bot", data.type || 'text', source);
    
    if (audioUnlocked && speechEnabled) {
      const speakerBtns = document.querySelectorAll('.btn-speaker');
      speakerBtns.forEach(btn => btn.classList.add('speaking'));
      
      speak(answerText, () => {
        speakerBtns.forEach(btn => btn.classList.remove('speaking'));
      });
    }
    
  } catch (error) {
    hideTypingIndicator();
    console.error('Error:', error);
    addMessage("I'm having trouble connecting right now. Please try again.", "bot", "error");
  }
  
  isProcessing = false;
}

// Speech synthesis
function speak(text, callback) {
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  
  utter = new SpeechSynthesisUtterance(text);
  utter.rate = 0.85; // Slightly slower for more gravitas
  utter.pitch = 0.7; // Lower pitch for deeper voice
  utter.volume = 1.0; // Full volume for presence
  
  const voices = speechSynthesis.getVoices();
  // Prefer male voices - add more male voice names based on common system voices
  const preferredVoice = voices.find(voice => 
    voice.name.includes('David') || // Windows male voice
    voice.name.includes('Mark') ||  // Mac male voice
    voice.name.includes('Daniel') || // British male voice
    voice.name.includes('James') ||  // Common male name in voices
    voice.name.includes('Thomas') || // Common male name in voices
    voice.name.toLowerCase().includes('male') || // Generic male indicator
    voice.name.includes('Google UK Male') // Google's male voice
  );
  if (preferredVoice) utter.voice = preferredVoice;
  
  if (callback) {
    utter.onend = callback;
  }
  
  speechSynthesis.speak(utter);
}

// Stop all functions
function stopAll() {
  if (recognition && recognitionActive) recognition.stop();
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  hideTypingIndicator();
  isProcessing = false;
  chatMicActive = false;
  recognitionActive = false;
  
  const micBtn = document.getElementById('micBtn');
  if (micBtn) micBtn.classList.remove('recording');
  
  const speakerBtns = document.querySelectorAll('.btn-speaker');
  speakerBtns.forEach(btn => btn.classList.remove('speaking'));
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    stopAll();
  } else if (e.ctrlKey && e.key === 'm') {
    e.preventDefault();
    if (currentMode === 'chat') {
      toggleChatMic();
    }
  } else if (e.ctrlKey && e.key === 's') {
    e.preventDefault();
    toggleSpeaker();
  }
});
</script>

</body>
</html>
